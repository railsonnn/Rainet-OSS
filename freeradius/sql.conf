# FreeRADIUS SQL Module Configuration
# PostgreSQL backend for authentication and accounting

sql {
    driver = "rlm_sql_postgresql"
    dialect = "postgresql"

    # Connection info
    server = "db"
    port = 5432
    login = "rainet"
    password = "rainet"
    radius_db = "rainet"

    # SQL queries
    authorize_check_query = "SELECT id, username, attribute, value, op FROM radcheck WHERE username = '%{SQL-User-Name}' ORDER BY id"
    authorize_reply_query = "SELECT id, username, attribute, value, op FROM radreply WHERE username = '%{SQL-User-Name}' ORDER BY id"

    # Accounting queries
    accounting_onoff_query = "UPDATE radacct SET acctstoptime = NOW(), acctsessiontime = CASE WHEN acctstarttime IS NOT NULL THEN EXTRACT(EPOCH FROM (NOW() - acctstarttime))::INTEGER ELSE 0 END, acctterminatecause = '%{Acct-Terminate-Cause}' WHERE acctstoptime IS NULL AND nasipaddress = '%{NAS-IP-Address}'"
    
    accounting_start_query = "INSERT INTO radacct (acctsessionid, acctuniqueid, username, realm, nasipaddress, nasportid, nasporttype, acctstarttime, acctupdatetime, acctstoptime, acctinterval, acctsessiontime, acctauthentic, connectinfo_start, connectinfo_stop, acctinputoctets, acctoutputoctets, calledstationid, callingstationid, acctterminatecause, servicetype, framedprotocol, framedipaddress) VALUES ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', '%{Realm}', '%{NAS-IP-Address}', '%{NAS-Port}', '%{NAS-Port-Type}', NOW(), NOW(), NULL, 0, 0, '%{Acct-Authentic}', '%{Connect-Info}', '', 0, 0, '%{Called-Station-Id}', '%{Calling-Station-Id}', '', '%{Service-Type}', '%{Framed-Protocol}', '%{Framed-IP-Address}')"
    
    accounting_update_query = "UPDATE radacct SET acctupdatetime = NOW(), acctinterval = EXTRACT(EPOCH FROM (NOW() - acctupdatetime))::INTEGER, acctsessiontime = CASE WHEN acctstarttime IS NOT NULL THEN EXTRACT(EPOCH FROM (NOW() - acctstarttime))::INTEGER ELSE 0 END, acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"
    
    accounting_stop_query = "UPDATE radacct SET acctstoptime = NOW(), acctsessiontime = CASE WHEN acctstarttime IS NOT NULL THEN EXTRACT(EPOCH FROM (NOW() - acctstarttime))::INTEGER ELSE 0 END, acctinputoctets = '%{Acct-Input-Octets}', acctoutputoctets = '%{Acct-Output-Octets}', acctterminatecause = '%{Acct-Terminate-Cause}', connectinfo_stop = '%{Connect-Info}' WHERE acctsessionid = '%{Acct-Session-Id}' AND username = '%{SQL-User-Name}' AND nasipaddress = '%{NAS-IP-Address}'"

    # Post-auth logging
    postauth_query = "INSERT INTO radpostauth (username, pass, reply, authdate) VALUES ('%{User-Name}', '%{%{User-Password}:-%{Chap-Password}}', '%{reply:Packet-Type}', NOW())"

    # Connection pool settings
    pool {
        start = 5
        min = 4
        max = 10
        spare = 3
        uses = 0
        lifetime = 0
        idle_timeout = 60
    }

    # Read clients from SQL (disabled, using clients.conf)
    read_clients = no
}
